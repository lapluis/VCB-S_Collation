# 压制成品文件规格

## 视频

* 内容

  逐帧画面内容一致, 时长相等, 总帧数正确

  应尽力确保排除非人为的预处理出错和重编码出错导致如花屏漏帧之类的错误

* 帧率

  采用逐行扫描 (Progressive)  
  原盘为隔行扫描的, 一般都应进行反交错处理并确保得到正确的画面和帧率

  确认视频的帧率模式和帧率数值正确  
  基本都是 CFR (Constant Frame Rate 固定帧率)  
  最常见的 CFR FPS 有 23.976 (24000/1001), 29.970 (30000/1001), 59.940 (60000/1001)  
  *当视频短于 30 秒且 MPNG 检测到 23.976 (23976/1000) 等分母为 1000 的帧率时, 为检测 BUG 也视为正确  
  *历史上曾有使用 1 FPS 帧率制作 Menu 特典的做法, 现已废弃, 新作项目应当避免这种做法  

* 分辨率

  通常分辨率应当与源 BD/DVD 相同, 但可能存在如下情况:

  黑边切割: 常见于剧场版  
  降采样: 片源有效分辨率整体低于 1080p 降采样来节省码率, 移动版的 720p 小体积版  
  升采样: 常见于 480p/576p 的 DVD 片源做成 720p

* 信息标注

  封装时应当保留完整且正确的编码参数信息, 包括:  
  `色彩范围 (Color Range), 色彩矩阵系数 (Matrix Coefficients), 色彩原色 (Color Primaries), 传输特性 (Transfer Characteristics)`  
  至少应当标注色彩范围和色彩矩阵系数  

  最常见的参数为 色彩范围: `Limited`, 色彩矩阵系数: `BT.709`, 色彩原色: `BT.709`, 传输特性: `BT.709`

  封装时应当正确填写视频轨道信息, 包括:   
  轨道语言 (Language): 不标注, 即 `und`  
  默认轨道 (Default): `yes`

* 封装格式和视频编码

  |类型|封装格式 (视频编码)|
  | ------------------------| --------------------------------------------------------|
  |标准版 动态视频|MKV (HEVC Main 10 \| Ma 444 10p)<br />MKV (AVC High 10)|
  |标准版 静态视频 有 BGM|MKV (AVC Hi444pp \| HEVC Main 10) \| PNG+FLAC|
  |标准版 静态视频 无 BGM|PNG|
  |移动版 动态视频|MKV/MP4 (HEVC Main \| HEVC Main 10 \| AVC High)|

  注意文件拓展名应该与文件实际封装格式一致  
  通常视频的色彩格式应当是 YUV420, 需要特别注意 YUV444 的情况


‍

## 音频

* 内容

  音画内容相符, 时间同步, 时长一致  
  数量齐全, 但要去除重复/冗余/置空等音轨

  通常音画的精准时长不会完全一致, 但至少应当保证秒级的一致, 允许数十毫秒的误差  
  音轨不允许有轨道延迟 (delay), 特别要注意转码 AAC 时如果参数错误可能导致产生数十毫秒的延迟  

* 格式

  声道数/位深/采样率保持原样

* 信息标注

  封装时应当正确填写音频轨道信息, 包括:   
  轨道语言 (Language): 必须正确标注, 日语 `ja`, 英语 `en`, 中文 `zh`   
  默认轨道 (Default): 有且仅有主音轨标注为 `yes`, 其它一律标注为 `no`; 包括外挂 MKA 中的音轨, 一律为 `no`

* 转码规则/保留规则/封装规则

  |源音轨分类|成品编码|封装位置|
  | ---------------------------------| ------------------| -------------------------------|
  |**标准版正片** 主音轨 无损 2.0CH|FLAC|内封 MKV|
  |**标准版正片** 主音轨 无损 >2.0CH|FLAC|外挂 MKA *另见(a)(b)|
  |**标准版正片** 主音轨 有损||丢弃 *另见(b)|
  |**标准版正片** 主音轨 特殊|具体讨论 *见(c)|外挂 MKA *另见(a)|
  |**标准版正片** 评论轨 无损 2.0/2.1CH|AAC CVBR 192kbps|内封 MKV (如已有 MKA 则外挂)|
  |**标准版正片** 评论轨 无损 5.1/7.1CH|AAC CVBR 320kbps|内封 MKV (如已有 MKA 则外挂)|
  |**标准版正片** 评论轨 有损 <512kbps|保持原样|内封 MKV (如已有 MKA 则外挂)|
  |**标准版正片** 评论轨 有损 >=512kbps 2.0/2.1CH|AAC CVBR 192kbps|内封 MKV (如已有 MKA 则外挂)|
  |**标准版正片** 评论轨 有损 >=512kbps 5.1/7.1CH|AAC CVBR 320kbps|内封 MKV (如已有 MKA 则外挂)|
  |**标准版特典** 动画 无损|FLAC|内封|
  |**标准版特典** 非动画 无损 2.0/2.1CH|AAC CVBR 192kbps|内封 MKV|
  |**标准版特典** 非动画 无损 5.1/7.1CH|AAC CVBR 320kbps|内封 MKV|
  |**标准版特典** 非动画 有损 <512kbps|保持原样|内封 MKV|
  |**标准版特典** 非动画 有损 >=512kbps 2.0/2.1CH|AAC CVBR 192kbps|内封 MKV|
  |**标准版特典** 非动画 有损 >=512kbps 5.1/7.1CH|AAC CVBR 320kbps|内封 MKV|
  |**移动版** 主音轨 2.0CH *另见(d)|AAC CVBR 192kbps|内封 MP4|
  |**移动版** 其它||丢弃|

  (a) 同一视频的所有外挂音轨均封装在同一个 MKA 文件里, 注意保持一致的轨道顺序  
  (b) 片源只有有损主音轨或 >2.0CH 无损主音轨的时候同样内封  
  (c) 特殊音轨: DTS Headphone X 转 FLAC; 视障音轨如果为无损则转 FLAC, 如果为有损则保持原样  
  (d) 对于部分特殊 MKV 移动版本/先行版本, 具体情况具体讨论

‍

## 章节

* 保留原则

  片源提供且时间点有意义的章节文件均应保留 (如正片和长特典)  
  存在多段分开内容的视频必须带有章节 (如 CM/PV Collection)

  去掉冗余章节点后, 仅剩开头章节点的应该删除章节

* 章节的时间点

  - 第一个章节点的时间戳必须是 00:00:00.000
  - 如果最后一个章节点的时间戳是视频结束, 或者离视频结束差一两秒的黑屏, 需要删除该章节点
  - 原盘章节的时间戳可能出错, 以实际视频画面需要的时间点为准
  - 由于压制过程需要依赖章节插入关键帧, 对章节时间的修改应当在压制之前

* 章节的内容文本

  默认为 `Chapter XX`​​ / `Chapter [0-9]{2}`​​ 从 01 开始连续编号

  也可以使用表达具体内容的章节时间内容, 最常见于演唱会  
  文本不要求还原 BD 菜单, 如要采用这样的章节文本请确保输入正确  
  如使用了任何非 ASCII 字符, 应在封装时为其选择合适的字符集

* 章节的放置

  内封于对应的视频文件 (MKV/MP4)

* 章节的信息标注

  对于 MKV 封装格式需要标注章节文件的语言, MP4 封装格式无法标注语言, 可忽略  
  采用默认编号文本的章节语言为 `en`​​  
  自定义章节文本则根据实际内容选择正确的语言如 `ja`​​ `zh`​​  
  整组章节应该使用相同的章节语言

‍

## 字幕

* 范围

  这里的字幕指的是原盘的图形字幕 (PGS), 对于合作字幕组提供的外挂字幕应当参考 <**字幕和字体包检查规范**>  

  在制作原盘菜单特典时, 有时会采用 PGS 字幕的方式还原菜单按钮画面, 这会导致出现几十甚至上百条 PGS 字幕, 这些字幕由工具生成, 原则上不需要符合后文的要求

* 内容

  字幕和画面内容相符, 时间同步, 时长一致  
  数量齐全, 但要去除重复/冗余/置空等字幕

  时长和轨道延迟的要求同音轨  
  PGS 作为图形字幕, 对视频分辨率敏感, 如果对视频做了裁剪黑边等操作, 要特别注意检查是否也正确处理了字幕

* 放置

  内封于对应的标准版视频文件中 (MKV), 移动版视频不带 (MP4 也带不了)

* 信息标注

  封装时应当正确填写字幕轨道信息, 包括:   
  轨道语言 (Language): 必须正确标注, 日语 `ja`, 英语 `en`, 中文 `zh`   
  默认轨道 (Default): 一律标注为 `no`


